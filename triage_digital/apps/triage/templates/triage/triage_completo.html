{% extends 'triage/base.html' %}

{% block title %}Triage Completo - Una Sola Pantalla{% endblock %}

{% block content %}
<style>
    /* Estilos especiales para selectores m√©dicos seguros */
    .form-select {
        border-left: 4px solid #28a745;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23198754' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    }
    
    .form-select:focus {
        border-left-color: #20c997;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .text-success {
        font-weight: 500;
    }
    
    /* Highlight para opciones cr√≠ticas */
    .form-select option[data-news="3"] {
        color: #dc2626;
        font-weight: bold;
    }
</style>
<div class="mobile-triage-form">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            
            <!-- Header minimalista -->
            <div class="card card-mobile mb-3">
                <div class="card-body p-3 text-center">
                    <h4 class="h5 h4-md mb-2">
                        <i class="bi bi-clipboard-heart text-primary"></i> 
                        Triage - Formulario
                    </h4>
                </div>
            </div>

            <!-- üö® INTERRUPTOR INTELIGENTE -->
            <div class="card border-warning mb-4">
                <div class="card-body p-3 text-center">
                    <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input fs-5" type="checkbox" 
                               role="switch" id="esInconsciente" name="es_inconsciente">
                        <label class="form-check-label fw-bold fs-6" for="esInconsciente">
                            üö® <span class="text-danger">PACIENTE INCONSCIENTE</span>
                        </label>
                    </div>
                    <div class="text-muted small mt-1">
                        Activar cuando el paciente no puede proporcionar datos
                    </div>
                </div>
            </div>

            <!-- Formulario unificado -->
            <form method="post" class="needs-validation" novalidate id="triageCompletoForm">
                {% csrf_token %}
                
                <!-- SECCI√ìN 1: DATOS DEL PACIENTE -->
                <div class="card card-mobile mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge"></i> 
                            <span class="d-mobile-none">1. Datos del Paciente</span>
                            <span class="d-md-none">1. Paciente</span>
                        </h5>
                    </div>
                    <div class="card-body p-3 p-md-4">
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label for="nombre" class="form-label fw-bold">
                                    <i class="bi bi-person text-info"></i> Nombre
                                </label>
                                <input type="text" class="form-control form-control-mobile" 
                                       id="nombre" name="nombre" maxlength="100" 
                                       placeholder="Juan Carlos" autocomplete="given-name">
                                <small class="text-muted">Opcional</small>
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="apellido" class="form-label fw-bold">
                                    <i class="bi bi-person text-info"></i> Apellido
                                </label>
                                <input type="text" class="form-control form-control-mobile" 
                                       id="apellido" name="apellido" maxlength="100" 
                                       placeholder="P√©rez" autocomplete="family-name">
                                <small class="text-muted">Opcional</small>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-12 col-md-4">
                                <label for="dni" class="form-label fw-bold">
                                    <i class="bi bi-card-text text-warning"></i> DNI
                                </label>
                                <input type="number" class="form-control form-control-mobile" 
                                       id="dni" name="dni" inputmode="numeric" 
                                       placeholder="12345678" maxlength="8">
                                <small class="text-muted">Opcional</small>
                            </div>
                            <div class="col-12 col-md-4">
                                <label for="edad" class="form-label fw-bold">
                                    <i class="bi bi-calendar text-success"></i> Edad
                                </label>
                                <input type="number" class="form-control form-control-mobile" 
                                       id="edad" name="edad" min="0" max="120" 
                                       inputmode="numeric" placeholder="45">
                                <small class="text-muted">A√±os aproximados</small>
                            </div>
                            <div class="col-12 col-md-4">
                                <label for="sexo" class="form-label fw-bold">
                                    <i class="bi bi-gender-ambiguous text-secondary"></i> Sexo
                                </label>
                                <select class="form-control form-control-mobile" id="sexo" name="sexo">
                                    <option value="">Seleccionar</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Femenino</option>
                                    <option value="X">No especificado</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label for="motivo_consulta" class="form-label fw-bold">
                                <i class="bi bi-chat-text text-primary"></i> Motivo de Consulta
                            </label>
                            <textarea class="form-control form-control-mobile" 
                                      id="motivo_consulta" name="motivo_consulta" 
                                      rows="2" maxlength="500" 
                                      placeholder="Dolor de pecho, dificultad respiratoria, etc..."></textarea>
                            <small class="text-muted">Opcional - Descripci√≥n breve</small>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN 2: SIGNOS VITALES -->
                <div class="card card-mobile mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-heart-pulse"></i> 
                            <span class="d-mobile-none">2. Signos Vitales - NEWS Score</span>
                            <span class="d-md-none">2. Signos Vitales</span>
                        </h5>
                    </div>
                    <div class="card-body p-3 p-md-4">
                        <div class="row g-3">
                            <!-- Frecuencia Respiratoria -->
                            <div class="col-12 col-lg-6">
                                <label for="frecuencia_respiratoria" class="form-label fw-bold">
                                    <i class="bi bi-lungs text-info"></i> Frecuencia Respiratoria *
                                </label>
                                <select class="form-select form-control-mobile" 
                                        id="frecuencia_respiratoria" name="frecuencia_respiratoria" 
                                        required>
                                    <option value="">Seleccionar rango...</option>
                                    <option value="8" data-news="3">‚â§8 resp/min (Muy baja)</option>
                                    <option value="11" data-news="1">9-11 resp/min (Baja)</option>
                                    <option value="18" data-news="0">12-20 resp/min (Normal)</option>
                                    <option value="22" data-news="2">21-24 resp/min (Alta)</option>
                                    <option value="26" data-news="3">‚â•25 resp/min (Muy alta)</option>
                                </select>
                                <small class="text-success">‚úì Valores seguros</small>
                            </div>

                            <!-- Saturaci√≥n Ox√≠geno -->
                            <div class="col-12 col-lg-6">
                                <label for="saturacion_oxigeno" class="form-label fw-bold">
                                    <i class="bi bi-droplet text-primary"></i> Saturaci√≥n de Ox√≠geno *
                                </label>
                                <select class="form-select form-control-mobile" 
                                        id="saturacion_oxigeno" name="saturacion_oxigeno" 
                                        required>
                                    <option value="">Seleccionar rango...</option>
                                    <option value="91" data-news="3">‚â§91% (Cr√≠tica)</option>
                                    <option value="93" data-news="2">92-93% (Baja)</option>
                                    <option value="95" data-news="1">94-95% (L√≠mite)</option>
                                    <option value="98" data-news="0">‚â•96% (Normal)</option>
                                </select>
                                <small class="text-success">‚úì Valores seguros</small>
                            </div>

                            <!-- Tensi√≥n Sist√≥lica -->
                            <div class="col-12 col-lg-6">
                                <label for="tension_sistolica" class="form-label fw-bold">
                                    <i class="bi bi-activity text-danger"></i> Tensi√≥n Sist√≥lica *
                                </label>
                                <select class="form-select form-control-mobile" 
                                        id="tension_sistolica" name="tension_sistolica" 
                                        required>
                                    <option value="">Seleccionar rango...</option>
                                    <option value="90" data-news="3">‚â§90 mmHg (Hipotensi√≥n severa)</option>
                                    <option value="100" data-news="2">91-100 mmHg (Hipotensi√≥n)</option>
                                    <option value="110" data-news="1">101-110 mmHg (Baja)</option>
                                    <option value="130" data-news="0">111-219 mmHg (Normal)</option>
                                    <option value="230" data-news="3">‚â•220 mmHg (Hipertensi√≥n severa)</option>
                                </select>
                                <small class="text-success">‚úì Valores seguros</small>
                            </div>

                            <!-- Frecuencia Card√≠aca -->
                            <div class="col-12 col-lg-6">
                                <label for="frecuencia_cardiaca" class="form-label fw-bold">
                                    <i class="bi bi-heart text-danger"></i> Frecuencia Card√≠aca *
                                </label>
                                <select class="form-select form-control-mobile" 
                                        id="frecuencia_cardiaca" name="frecuencia_cardiaca" 
                                        required>
                                    <option value="">Seleccionar rango...</option>
                                    <option value="40" data-news="3">‚â§40 lpm (Bradicardia severa)</option>
                                    <option value="50" data-news="1">41-50 lpm (Bradicardia)</option>
                                    <option value="90" data-news="0">51-90 lpm (Normal)</option>
                                    <option value="110" data-news="1">91-110 lpm (Taquicardia leve)</option>
                                    <option value="130" data-news="2">111-130 lpm (Taquicardia)</option>
                                    <option value="140" data-news="3">‚â•131 lpm (Taquicardia severa)</option>
                                </select>
                                <small class="text-success">‚úì Valores seguros</small>
                            </div>

                            <!-- Temperatura -->
                            <div class="col-12 col-lg-6">
                                <label for="temperatura" class="form-label fw-bold">
                                    <i class="bi bi-thermometer text-warning"></i> Temperatura *
                                </label>
                                <select class="form-select form-control-mobile" 
                                        id="temperatura" name="temperatura" 
                                        required>
                                    <option value="">Seleccionar rango...</option>
                                    <option value="35.0" data-news="3">‚â§35.0¬∞C (Hipotermia severa)</option>
                                    <option value="36.0" data-news="1">35.1-36.0¬∞C (Hipotermia leve)</option>
                                    <option value="37.0" data-news="0">36.1-38.0¬∞C (Normal)</option>
                                    <option value="39.0" data-news="1">38.1-39.0¬∞C (Fiebre leve)</option>
                                    <option value="40.0" data-news="2">‚â•39.1¬∞C (Fiebre alta)</option>
                                </select>
                                <small class="text-success">‚úì Valores seguros</small>
                            </div>

                            <!-- Nivel de Conciencia -->
                            <div class="col-12 col-lg-6">
                                <label for="nivel_conciencia" class="form-label fw-bold">
                                    <i class="bi bi-eye text-success"></i> Nivel de Conciencia *
                                </label>
                                <select class="form-select form-control-mobile" 
                                        id="nivel_conciencia" name="nivel_conciencia" required>
                                    <option value="">Seleccionar nivel...</option>
                                    <option value="A" data-news="0">A - Alerta y orientado (Normal)</option>
                                    <option value="V" data-news="3">V - Responde a est√≠mulos verbales</option>
                                    <option value="P" data-news="3">P - Responde solo a dolor</option>
                                    <option value="U" data-news="3">U - No responde (inconsciente)</option>
                                </select>
                                <small class="text-success">‚úì Escala AVPU</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN 3: RESULTADO NEWS -->
                <div class="card card-mobile mb-4" id="resultadoCard" style="display: none;">
                    <div class="card-header text-white" id="resultadoHeader">
                        <h5 class="mb-0">
                            <i class="bi bi-calculator"></i> 
                            <span class="d-mobile-none">3. Resultado del Triage</span>
                            <span class="d-md-none">3. Resultado</span>
                        </h5>
                    </div>
                    <div class="card-body text-center p-4">
                        <div class="row">
                            <div class="col-md-4">
                                <h2 id="newsScore" class="display-4 fw-bold">--</h2>
                                <p class="mb-0"><strong>NEWS Score</strong></p>
                            </div>
                            <div class="col-md-4">
                                <h3 id="nivelUrgencia" class="h2">--</h3>
                                <p class="mb-0"><strong>Nivel de Urgencia</strong></p>
                            </div>
                            <div class="col-md-4">
                                <h4 id="tiempoAtencion" class="h3">--</h4>
                                <p class="mb-0"><strong>Tiempo M√°ximo</strong></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div class="row g-2 mb-4">
                    <div class="col-12 col-md-6 order-2 order-md-1">
                        <a href="{% url 'triage:dashboard' %}" 
                           class="btn btn-secondary btn-mobile w-100 touch-target">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                    </div>
                    <div class="col-12 col-md-6 order-1 order-md-2">
                        <button type="submit" class="btn btn-success btn-mobile w-100 touch-target" id="btnCompletar">
                            <i class="bi bi-check-circle"></i> 
                            <span class="d-mobile-none">Completar Triage</span>
                            <span class="d-md-none">Completar</span>
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- JavaScript para c√°lculo en tiempo real -->
<script>
// üöÄ JAVASCRIPT ULTRA-MINIMALISTA: 15 l√≠neas que hacen TODO
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('select[data-news]');
    const switchCritico = document.getElementById('esInconsciente');
    const campos = document.querySelectorAll('#nombre, #apellido, #dni, #edad, #sexo, #motivo_consulta');
    
    // MEGA-FUNCI√ìN: Calculadora + Switch + Validaci√≥n en 1 
    function todo() {
        // 1. Calcular NEWS Score en 1 l√≠nea
        const score = Array.from(selects).reduce((sum, s) => sum + parseInt(s.options[s.selectedIndex]?.dataset.news || 0), 0);
        
        // 2. Mostrar resultado inmediato
        const nivel = score >= 7 ? 'ROJO' : score >= 4 ? 'AMARILLO' : 'VERDE';
        const color = score >= 7 ? 'danger' : score >= 4 ? 'warning' : 'success';
        document.getElementById('newsScore').textContent = score;
        document.getElementById('nivelUrgencia').textContent = nivel;
        document.getElementById('resultadoCard').style.display = score > 0 ? 'block' : 'none';
        document.getElementById('resultadoHeader').className = `card-header text-white bg-${color}`;
        
        // 3. Switch cr√≠tico en 1 l√≠nea
        campos.forEach(c => { c.disabled = switchCritico.checked; c.style.opacity = switchCritico.checked ? '0.6' : '1'; });
        document.querySelector('.card-body h4').innerHTML = switchCritico.checked ? 
            '<i class="bi bi-clipboard-heart text-danger"></i> üö® TRIAGE CR√çTICO' : 
            '<i class="bi bi-clipboard-heart text-primary"></i> Triage - Formulario';
    }
    
    // 4. UN SOLO LISTENER para TODO
    document.addEventListener('change', todo);
});
</script>

{% endblock %}