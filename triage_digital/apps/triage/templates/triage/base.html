<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Triage Digital - Sistema Hospitalario{% endblock %}</title>
    
    <link rel="manifest" href="{% url 'triage:manifest' %}">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Triage Digital">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        /* Colores triage */
        .triage-rojo{background:#dc3545;color:#fff}
        .triage-amarillo{background:#ffc107;color:#000}
        .triage-verde{background:#28a745;color:#fff}
        .urgente{animation:p 1s infinite}
        @keyframes p{50%{opacity:.5}}
        
        /* Mobile-first minimalista */
        .btn-mobile{min-height:48px;font-size:1.1rem;font-weight:600;border-radius:8px;margin:4px 0}
        .form-control-mobile{min-height:48px;font-size:1.1rem;border-radius:8px;border:2px solid #dee2e6}
        .form-control-mobile:focus{border-color:#0d6efd;box-shadow:0 0 0 .2rem rgba(13,110,253,.25)}
        .card-mobile{margin-bottom:1rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        @media (min-width:768px){.btn-mobile{min-height:42px;font-size:1rem}.form-control-mobile{min-height:42px;font-size:1rem}}
        @media (min-width:992px){.btn-mobile{min-height:38px;font-size:.9rem}.form-control-mobile{min-height:38px;font-size:.9rem}}
    </style>
</head>
<body>
    <!-- Navbar m√©dico minimalista -->
    <nav class="navbar navbar-expand-md navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'triage:dashboard' %}">
                <i class="bi bi-hospital"></i> Triage Digital
            </a>
            
            {% if user.is_authenticated %}
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="{% url 'triage:dashboard' %}">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <button class="nav-link touch-target btn btn-link d-lg-none text-start" type="button" 
                            data-bs-toggle="offcanvas" data-bs-target="#sidebarMovil">
                        <i class="bi bi-people"></i> 
                        <span>Ver Pacientes</span> 
                        <span class="badge bg-primary ms-2" id="contador-pacientes-mobile">0</span>
                    </button>
                    
                    
                    <!-- Usuario y logout -->
                    <div class="navbar-text d-mobile-none">
                        <i class="bi bi-person-badge"></i> {{ user.get_full_name|default:user.username }}
                    </div>
                    <a class="nav-link touch-target text-warning" href="{% url 'logout' %}">
                        <i class="bi bi-box-arrow-right"></i> Salir
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </nav>

    <!-- Sidebar m√≥vil (offcanvas) -->
    <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="sidebarMovil">
        <div class="offcanvas-header bg-primary text-white">
            <h5 class="offcanvas-title">
                <i class="bi bi-people-fill"></i> Pacientes en Espera
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <div class="p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <small class="text-muted">Actualizaci√≥n autom√°tica</small>
                    <button class="btn btn-sm btn-outline-primary" onclick="cargarPacientes()" title="Actualizar lista">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div id="panel-pacientes-mobile">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <div class="mt-2">Cargando pacientes...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            {% if user.is_authenticated %}
            <!-- Panel lateral fijo - Lista de pacientes en tiempo real -->
            <div class="col-lg-3 d-lg-block bg-light sidebar border-end">
                <div class="position-sticky pt-3" style="top: 76px; height: calc(100vh - 76px); overflow-y: auto;">
                    <div class="px-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 text-primary">
                                <i class="bi bi-people-fill"></i> Pacientes en Espera
                            </h6>
                            <span class="badge bg-primary rounded-pill" id="contador-pacientes">0</span>
                        </div>
                        
                        <!-- Bot√≥n de actualizaci√≥n manual -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <small class="text-muted">Actualizaci√≥n autom√°tica</small>
                            <button class="btn btn-sm btn-outline-primary" onclick="cargarPacientes()" title="Actualizar lista">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        
                        <!-- Lista de pacientes -->
                        <div id="panel-pacientes">
                            <div class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <div class="mt-2">Cargando pacientes...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Contenido principal -->
            <main class="{% if user.is_authenticated %}col-lg-9{% else %}col-12{% endif %} px-md-4">
                
                <!-- Mensajes de Django -->
                {% if messages %}
                <div class="mt-3">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Contenido de la p√°gina -->
                {% block content %}
                {% endblock %}
            </main>
        </div>
    </div>

    <!-- Bootstrap JS + JavaScript vanilla -->
        <!-- Bootstrap 5 JS minificado -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    <!-- JavaScript personalizado -->
    <script>
        // Auto-refresh para casos cr√≠ticos
        function actualizarDashboard() {
            // Solo en p√°gina dashboard
            if (window.location.pathname.includes('triage/')) {
                window.location.reload();
            }
        }

        // Refresh cada 5 minutos para datos cr√≠ticos
        setInterval(actualizarDashboard, 300000);
        
        // Funci√≥n para cargar lista de pacientes en sidebar
        function cargarPacientes() {
            const panel = document.getElementById('panel-pacientes');
            const panelMobile = document.getElementById('panel-pacientes-mobile');
            if (!panel && !panelMobile) return;
            
            // Mostrar loading en ambos paneles
            const loadingHtml = `
                <div class="text-center text-muted py-3">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Actualizando...</span>
                    </div>
                    <div class="mt-2 small">Actualizando...</div>
                </div>
            `;
            if (panel) panel.innerHTML = loadingHtml;
            if (panelMobile) panelMobile.innerHTML = loadingHtml;
            
            // Fetch lista de pacientes
            fetch('/triage/api/lista-pacientes/')
                .then(response => response.json())
                .then(data => {
                    // Actualizar contadores
                    const contador = document.getElementById('contador-pacientes');
                    const contadorMobile = document.getElementById('contador-pacientes-mobile');
                    if (contador) contador.textContent = data.length;
                    if (contadorMobile) contadorMobile.textContent = data.length;
                    
                    if (data.length === 0) {
                        const emptyHtml = `
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-check-circle-fill text-success fs-1"></i>
                                <div class="mt-2 small">¬°No hay pacientes esperando!</div>
                            </div>
                        `;
                        if (panel) panel.innerHTML = emptyHtml;
                        if (panelMobile) panelMobile.innerHTML = emptyHtml;
                        return;
                    }
                    
                    let html = '';
                    data.forEach(paciente => {
                        const tiempoColor = paciente.tiempo_espera_minutos > 30 ? 'text-danger' : 'text-warning';
                        const nivelColor = paciente.nivel_urgencia === 'ROJO' ? 'danger' : 
                                          paciente.nivel_urgencia === 'AMARILLO' ? 'warning' : 'success';
                        
                        // üö® Indicador de prioridad cr√≠tica para c√≥digos rojos
                        const prioridadIndicador = paciente.nivel_urgencia === 'ROJO' && paciente.prioridad_critica > 0 ? 
                            `<span class="badge bg-danger-dark small ms-1">‚ö° P${Math.floor(paciente.prioridad_critica/100)}</span>` : '';
                        
                        html += `
                            <div class="card card-sm mb-2 border-${nivelColor}" id="paciente-${paciente.id}">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="card-title mb-1 small">${paciente.nombre_completo}${prioridadIndicador}</h6>
                                            <div class="small text-muted mb-1">
                                                ${paciente.dni ? 'DNI: ' + paciente.dni : 'Sin DNI'}
                                                ${paciente.edad ? ' | ' + paciente.edad + ' a√±os' : ''}
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-${nivelColor} small">${paciente.nivel_urgencia}</span>
                                                <div class="d-flex align-items-center">
                                                    <small class="${tiempoColor} me-2">
                                                        <i class="bi bi-clock"></i> ${paciente.tiempo_espera}
                                                    </small>
                                                    <div class="btn-group" role="group" style="gap: 4px;">
                                                        <button class="btn btn-primary btn-sm px-3 py-2" 
                                                                onclick="marcarAtendido(${paciente.id}, '${paciente.nombre_completo}', 'PASE_A_SALA')"
                                                                title="Pase a Sala"
                                                                style="min-width: 45px;">
                                                            <i class="bi bi-hospital"></i>
                                                        </button>
                                                        <button class="btn btn-success btn-sm px-3 py-2" 
                                                                onclick="marcarAtendido(${paciente.id}, '${paciente.nombre_completo}', 'ALTA')"
                                                                title="Alta"
                                                                style="min-width: 45px;">
                                                            <i class="bi bi-check-circle"></i>
                                                        </button>
                                                        <button class="btn btn-warning btn-sm px-3 py-2" 
                                                                onclick="marcarAtendido(${paciente.id}, '${paciente.nombre_completo}', 'PASE_A_UTI')"
                                                                title="Pase a UTI"
                                                                style="min-width: 45px;">
                                                            <i class="bi bi-exclamation-triangle"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    // Actualizar ambos paneles
                    if (panel) panel.innerHTML = html;
                    if (panelMobile) panelMobile.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando pacientes:', error);
                    const errorHtml = `
                        <div class="text-center text-danger py-3">
                            <i class="bi bi-exclamation-triangle"></i>
                            <div class="mt-2 small">Error al cargar pacientes</div>
                        </div>
                    `;
                    if (panel) panel.innerHTML = errorHtml;
                    if (panelMobile) panelMobile.innerHTML = errorHtml;
                });
        }
        
        // Cargar pacientes al iniciar y cada 30 segundos
        if (document.getElementById('panel-pacientes') || document.getElementById('panel-pacientes-mobile')) {
            cargarPacientes();
            setInterval(cargarPacientes, 30000); // Actualizar cada 30 segundos
        }
        
        // Funci√≥n para marcar paciente como atendido con destino espec√≠fico
        function marcarAtendido(pacienteId, nombrePaciente, destino) {
            const destinosTexto = {
                'PASE_A_SALA': 'ser√° trasladado a Sala',
                'ALTA': 'ser√° dado de alta',
                'PASE_A_UTI': 'ser√° trasladado a UTI'
            };
            
            const textoDestino = destinosTexto[destino] || 'ser√° atendido';
            
            if (!confirm(`¬øConfirma que ${nombrePaciente} ${textoDestino}?`)) {
                return;
            }
            
            // Deshabilitar todos los botones del grupo mientras se procesa
            const contenedorBotones = document.querySelector(`#paciente-${pacienteId} .btn-group`);
            if (contenedorBotones) {
                const botones = contenedorBotones.querySelectorAll('button');
                botones.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                });
            }
            
            // Llamada AJAX para marcar como atendido con destino espec√≠fico
            fetch(`/triage/paciente/${pacienteId}/atendido/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                   document.querySelector('meta[name=csrf-token]')?.content ||
                                   getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    destino: destino
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const mensajesExito = {
                        'PASE_A_SALA': `üè• ${nombrePaciente} trasladado a Sala`,
                        'ALTA': `‚úÖ ${nombrePaciente} dado de alta`,
                        'PASE_A_UTI': `üö® ${nombrePaciente} trasladado a UTI`
                    };
                    
                    const mensajeExito = mensajesExito[destino] || `‚úÖ ${nombrePaciente} atendido`;
                    
                    // Mostrar mensaje de √©xito
                    mostrarMensaje(mensajeExito, 'success');
                    
                    // Remover de la vista inmediatamente
                    const tarjeta = document.getElementById(`paciente-${pacienteId}`);
                    if (tarjeta) {
                        tarjeta.style.transition = 'all 0.3s ease';
                        tarjeta.style.opacity = '0';
                        tarjeta.style.transform = 'translateX(100%)';
                        setTimeout(() => tarjeta.remove(), 300);
                    }
                    
                    // üöÄ ACTUALIZACI√ìN INMEDIATA Y EFICIENTE
                    
                    // 1. Recargar lista de pacientes inmediatamente
                    cargarPacientes();
                    
                    // 2. Actualizar estad√≠sticas del dashboard si estamos en √©l
                    if (window.location.pathname.includes('/triage/dashboard/') || 
                        window.location.pathname === '/triage/') {
                        actualizarEstadisticasDashboard();
                    }
                    
                    // 3. Actualizar contador de pacientes
                    actualizarContadorPacientes();
                    
                } else {
                    mostrarMensaje(`‚ùå Error: ${data.error}`, 'error');
                    // Rehabilitar botones
                    if (contenedorBotones) {
                        const botones = contenedorBotones.querySelectorAll('button');
                        const iconos = {
                            'PASE_A_SALA': '<i class="bi bi-hospital"></i>',
                            'ALTA': '<i class="bi bi-check-circle"></i>',
                            'PASE_A_UTI': '<i class="bi bi-exclamation-triangle"></i>'
                        };
                        botones.forEach((btn, index) => {
                            btn.disabled = false;
                            const destinosArray = ['PASE_A_SALA', 'ALTA', 'PASE_A_UTI'];
                            btn.innerHTML = iconos[destinosArray[index]] || '<i class="bi bi-check"></i>';
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('‚ùå Error de conexi√≥n', 'error');
                // Rehabilitar botones
                if (contenedorBotones) {
                    const botones = contenedorBotones.querySelectorAll('button');
                    const iconos = {
                        'PASE_A_SALA': '<i class="bi bi-hospital"></i>',
                        'ALTA': '<i class="bi bi-check-circle"></i>',
                        'PASE_A_UTI': '<i class="bi bi-exclamation-triangle"></i>'
                    };
                    botones.forEach((btn, index) => {
                        btn.disabled = false;
                        const destinosArray = ['PASE_A_SALA', 'ALTA', 'PASE_A_UTI'];
                        btn.innerHTML = iconos[destinosArray[index]] || '<i class="bi bi-check"></i>';
                    });
                }
            });
        }
        
        // Funci√≥n para mostrar mensajes temporales
        function mostrarMensaje(mensaje, tipo) {
            const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 80px; right: 20px; z-index: 9999; min-width: 300px;">
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Agregar al body
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remover despu√©s de 3 segundos
            setTimeout(() => {
                const alert = document.querySelector('.alert.position-fixed');
                if (alert) alert.remove();
            }, 3000);
        }
        
        // Funci√≥n helper para obtener CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // üì± Service Worker para PWA y funcionamiento offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('{% url "triage:service_worker" %}')
                    .then(registration => {
                        console.log('üè• SW registrado:', registration.scope);
                        
                        // Mostrar banner de instalaci√≥n solo una vez
                        if (!localStorage.getItem('pwa-banner-shown')) {
                            mostrarBannerInstalacion();
                        }
                    })
                    .catch(error => console.log('SW error:', error));
            });
        }
        
        // Banner de instalaci√≥n PWA
        function mostrarBannerInstalacion() {
            const banner = document.createElement('div');
            banner.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-2';
            banner.style.zIndex = '9999';
            banner.innerHTML = `
                <i class="bi bi-download"></i> 
                <strong>üì± Instalar Triage Digital</strong><br>
                <small>Agregar a pantalla de inicio para acceso r√°pido</small>
                <button type="button" class="btn-close" onclick="this.parentElement.remove(); localStorage.setItem('pwa-banner-shown', 'true')"></button>
            `;
            document.body.appendChild(banner);
            
            // Auto-hide despu√©s de 10 segundos
            setTimeout(() => {
                if (banner.parentElement) {
                    banner.remove();
                    localStorage.setItem('pwa-banner-shown', 'true');
                }
            }, 10000);
        }
        
        // üöÄ FUNCIONES DE ACTUALIZACI√ìN EFICIENTE POST-ATENCI√ìN
        
        // Actualizar estad√≠sticas del dashboard sin recargar p√°gina
        function actualizarEstadisticasDashboard() {
            
            fetch('/triage/api/estadisticas-dashboard/')
                .then(response => response.json())
                .then(data => {
                    
                    // Actualizar cards de estad√≠sticas
                    const rojosElement = document.querySelector('.card.border-danger .h2-md, .card.border-danger .h4');
                    const amarillosElement = document.querySelector('.card.border-warning .h2-md, .card.border-warning .h4');
                    const verdesElement = document.querySelector('.card.border-success .h2-md, .card.border-success .h4');
                    const totalElement = document.querySelector('.card.border-info .h2-md, .card.border-info .h4');
                    
                    if (rojosElement) rojosElement.textContent = data.rojos || 0;
                    if (amarillosElement) amarillosElement.textContent = data.amarillos || 0;
                    if (verdesElement) verdesElement.textContent = data.verdes || 0;
                    if (totalElement) totalElement.textContent = data.total || 0;
                    
                    // Actualizar alerta cr√≠tica
                    const alertaCritica = document.querySelector('.alert.alert-danger');
                    if (data.rojos > 0) {
                        if (!alertaCritica) {
                            // Crear alerta si no existe
                            const alertaHTML = `
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>¬°ATENCI√ìN!</strong> Hay ${data.rojos} caso${data.rojos > 1 ? 's' : ''} cr√≠tico${data.rojos > 1 ? 's' : ''} que requieren atenci√≥n inmediata.
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            `;
                            const container = document.querySelector('.mobile-dashboard');
                            if (container) {
                                container.insertAdjacentHTML('afterbegin', alertaHTML);
                            }
                        } else {
                            // Actualizar alerta existente
                            alertaCritica.innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>¬°ATENCI√ìN!</strong> Hay ${data.rojos} caso${data.rojos > 1 ? 's' : ''} cr√≠tico${data.rojos > 1 ? 's' : ''} que requieren atenci√≥n inmediata.
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                        }
                    } else if (alertaCritica) {
                        // Remover alerta si no hay casos cr√≠ticos
                        alertaCritica.remove();
                    }
                    
                })
                .catch(error => {
                    console.error('‚ùå Error actualizando estad√≠sticas:', error);
                });
        }
        
        // Actualizar contador de pacientes en sidebar
        function actualizarContadorPacientes() {
            
            // Contar pacientes actuales en el DOM
            const pacientesEnSidebar = document.querySelectorAll('#panel-pacientes .card').length;
            const pacientesEnMobile = document.querySelectorAll('#panel-pacientes-mobile .card').length;
            
            const totalPacientes = Math.max(pacientesEnSidebar, pacientesEnMobile);
            
            // Actualizar contadores
            const contador = document.getElementById('contador-pacientes');
            const contadorMobile = document.getElementById('contador-pacientes-mobile');
            
            if (contador) {
                contador.textContent = totalPacientes;
            }
            if (contadorMobile) {
                contadorMobile.textContent = totalPacientes;
            }
        }
    </script>

    {% block extra_js %}
    {% endblock %}
</body>
</html>