{% extends 'triage/base.html' %}

{% block title %}Dashboard - Triage Digital{% endblock %}

{% block content %}
{% csrf_token %}
<div class="mobile-dashboard">
    <!-- Header responsive -->
    <div class="d-flex justify-content-between align-items-center py-2 py-md-3">
        <div>
            <h1 class="h3 h1-md mb-1">
                <i class="bi bi-speedometer2"></i> 
                <span class="d-mobile-none">Dashboard M√©dico</span>
                <span class="d-md-none">Dashboard</span>
            </h1>
            {% if profesional %}
            <div class="small text-muted">
                üîí <strong>{{ profesional.get_tipo_display }}</strong> - {{ profesional.user.get_full_name|default:profesional.user.username }}
                {% if profesional.puede_descargar_reportes %}
                    <span class="badge bg-primary ms-1">üìä Reportes</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="text-end">
            <small class="text-muted d-block">{{ "now"|date:"H:i" }}</small>
            <small class="badge bg-success d-mobile-none">Optimizado</small>
            {% if profesional.puede_descargar_reportes %}
            <div class="mt-1">
                <a href="{% url 'triage:reporte_diario' %}" class="btn btn-sm btn-outline-primary" target="_blank" title="Descargar reporte diario con detalles por profesional">
                    <i class="bi bi-download"></i> <span class="d-none d-md-inline">Reporte PDF</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>

<!-- Alertas cr√≠ticas -->
{% if estadisticas.rojos > 0 %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>¬°ATENCI√ìN!</strong> Hay {{ estadisticas.rojos }} caso{{ estadisticas.rojos|pluralize }} cr√≠tico{{ estadisticas.rojos|pluralize }} que requieren atenci√≥n inmediata.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

    <!-- Estad√≠sticas compactas - Optimizadas para formulario -->
    <div class="row mb-2 g-1 g-md-2">
        <div class="col-3">
            <div class="card border-danger card-mobile text-center">
                <div class="card-body p-2">
                    <h4 class="h3 text-danger mb-0">{{ estadisticas.rojos|default:0 }}</h4>
                    <small class="fw-bold">CR√çTICOS</small>
                </div>
            </div>
        </div>
        <div class="col-3">
            <div class="card border-warning card-mobile text-center">
                <div class="card-body p-2">
                    <h4 class="h3 text-warning mb-0">{{ estadisticas.amarillos|default:0 }}</h4>
                    <small class="fw-bold">URGENTES</small>
                </div>
            </div>
        </div>
        <div class="col-3">
            <div class="card border-success card-mobile text-center">
                <div class="card-body p-2">
                    <h4 class="h3 text-success mb-0">{{ estadisticas.verdes|default:0 }}</h4>  
                    <small class="fw-bold">RUTINARIOS</small>
                </div>
            </div>
        </div>
        <div class="col-3">
            <div class="card border-info card-mobile text-center">
                <div class="card-body p-2">
                    <h4 class="h3 text-info mb-0">{{ estadisticas.total|default:0 }}</h4>
                    <small class="fw-bold">TOTAL</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Acci√≥n r√°pida: Reporte PDF - Solo para administradores -->
    {% if profesional.puede_descargar_reportes %}
    <div class="row mb-3 mb-md-4">
        <div class="col-12 col-lg-6 mx-auto">
            <div class="d-grid">
                <a href="{% url 'triage:reporte_diario' %}" class="btn btn-info btn-lg btn-mobile touch-target">
                    <i class="bi bi-file-earmark-pdf me-2"></i>
                    <span class="d-mobile-none">üìä Generar Reporte PDF Diario</span>
                    <span class="d-md-none">üìä Reporte PDF</span>
                </a>
            </div>
        </div>
    </div>
    {% endif %}

<div class="row">
    <!-- FORMULARIO TRIAGE COMPLETO - ANCHO COMPLETO PARA MEJOR VISIBILIDAD -->
    <div class="col-12">
        <div class="card card-mobile">
            <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard2-pulse"></i> 
                    <span class="d-mobile-none">ü©∫ Triage Completo con Calculadora NEWS</span>
                    <span class="d-lg-none">ü©∫ Nuevo Triage</span>
                </h5>
                <span class="badge bg-light text-primary">Sistema Inteligente</span>
            </div>
            <div class="card-body p-2 p-md-3">
                
                <!-- Formulario unificado -->
                <form method="post" class="needs-validation" novalidate id="triageCompletoFormDashboard">
                    {% csrf_token %}
                    
                    <!-- SECCI√ìN COMPACTA: DATOS DEL PACIENTE -->
                    <div class="card mb-3 border-info">
                        <div class="card-header bg-info text-white py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-person-badge"></i> Datos del Paciente
                            </h6>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-6 col-md-3">
                                    <label for="nombre_dash" class="form-label small fw-bold">Nombre</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="nombre_dash" name="nombre" maxlength="100" 
                                           placeholder="Juan Carlos">
                                    <small class="text-muted">Opcional</small>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label for="apellido_dash" class="form-label small fw-bold">Apellido</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           id="apellido_dash" name="apellido" maxlength="100" 
                                           placeholder="P√©rez">
                                    <small class="text-muted">Opcional</small>
                                </div>
                                <div class="col-6 col-md-2">
                                    <label for="dni_dash" class="form-label small fw-bold">DNI</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="dni_dash" name="dni" placeholder="12345678">
                                    <small class="text-muted">Opcional</small>
                                </div>
                                <div class="col-6 col-md-2">
                                    <label for="edad_dash" class="form-label small fw-bold">Edad</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="edad_dash" name="edad" min="0" max="120" placeholder="45">
                                </div>
                                <div class="col-12 col-md-2">
                                    <label for="sexo_dash" class="form-label small fw-bold">Sexo</label>
                                    <select class="form-control form-control-sm" id="sexo_dash" name="sexo">
                                        <option value="">-</option>
                                        <option value="M">M</option>
                                        <option value="F">F</option>
                                        <option value="X">X</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-2">
                                <label for="motivo_consulta_dash" class="form-label small fw-bold">Motivo de Consulta</label>
                                <textarea class="form-control form-control-sm" 
                                          id="motivo_consulta_dash" name="motivo_consulta" 
                                          rows="2" maxlength="500" 
                                          placeholder="Descripci√≥n breve del motivo..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- CALCULADORA NEWS COMPACTA -->
                    <div class="card mb-3 border-warning">
                        <div class="card-header bg-warning text-dark py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-calculator"></i> Calculadora NEWS
                                </h6>
                                <div id="resultado-rapido" class="d-none">
                                    <span id="puntaje-rapido" class="badge bg-secondary">--</span>
                                    <span id="color-rapido" class="badge bg-secondary ms-1">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            
                            <!-- Resultado en tiempo real -->
                            <div class="panel-resultado-mini p-2 rounded text-center bg-light mb-3">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <div id="colorResultadoMiniDash" class="color-resultado-mini bg-secondary text-white rounded p-2 small">
                                            <span id="textoColorMiniDash">Selecciona valores</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div id="puntajeTotalMiniDash" class="h4 text-muted">--</div>
                                        <small class="text-muted">Puntaje NEWS</small>
                                    </div>
                                    <div class="col-md-4">
                                        <div id="tiempoAtencionMiniDash" class="d-none">
                                            <div id="textoTiempoMiniDash" class="fw-bold small"></div>
                                            <small class="text-muted">Tiempo m√°ximo</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Signos vitales en formato compacto - 3 columnas para mejor aprovechamiento -->
                            <div class="row g-2">
                                
                                <!-- Frecuencia Respiratoria -->
                                <div class="col-12 col-lg-4">
                                    <div class="border rounded p-2 bg-white">
                                        <label class="form-label small fw-bold mb-1">
                                            <i class="bi bi-lungs text-info"></i> Freq. Respiratoria
                                            <span id="puntaje-frecuencia_respiratoria-display-dash" class="badge bg-secondary ms-1">-</span>
                                        </label>
                                        <div class="btn-group-vertical d-grid gap-1" data-signo="frecuencia_respiratoria">
                                            <div class="row g-1">
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="8" data-puntaje="3">
                                                        ‚â§8 <small>(3)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="10" data-puntaje="1">
                                                        9-11 <small>(1)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-success btn-valor btn-sm w-100" data-valor="16" data-puntaje="0">
                                                        12-20 <small>(0)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="23" data-puntaje="2">
                                                        21-24 <small>(2)</small>
                                                    </button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="25" data-puntaje="3">
                                                ‚â•25 <small>(3)</small>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Saturaci√≥n Ox√≠geno -->
                                <div class="col-12 col-lg-4">
                                    <div class="border rounded p-2 bg-white">
                                        <label class="form-label small fw-bold mb-1">
                                            <i class="bi bi-droplet text-primary"></i> Sat. Ox√≠geno
                                            <span id="puntaje-saturacion_oxigeno-display-dash" class="badge bg-secondary ms-1">-</span>
                                        </label>
                                        <div class="btn-group-vertical d-grid gap-1" data-signo="saturacion_oxigeno">
                                            <div class="row g-1">
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="91" data-puntaje="3">
                                                        ‚â§91% <small>(3)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="92" data-puntaje="2">
                                                        92-93% <small>(2)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="94" data-puntaje="1">
                                                        94-95% <small>(1)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-success btn-valor btn-sm w-100" data-valor="98" data-puntaje="0">
                                                        ‚â•96% <small>(0)</small>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Presi√≥n Arterial -->
                                <div class="col-12 col-lg-4">
                                    <div class="border rounded p-2 bg-white">
                                        <label class="form-label small fw-bold mb-1">
                                            <i class="bi bi-heart-pulse text-danger"></i> P.A. Sist√≥lica
                                            <span id="puntaje-tension_sistolica-display-dash" class="badge bg-secondary ms-1">-</span>
                                        </label>
                                        <div class="btn-group-vertical d-grid gap-1" data-signo="tension_sistolica">
                                            <div class="row g-1">
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="90" data-puntaje="3">
                                                        ‚â§90 <small>(3)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="95" data-puntaje="2">
                                                        91-100 <small>(2)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="105" data-puntaje="1">
                                                        101-110 <small>(1)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-success btn-valor btn-sm w-100" data-valor="120" data-puntaje="0">
                                                        111-219 <small>(0)</small>
                                                    </button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="220" data-puntaje="3">
                                                ‚â•220 <small>(3)</small>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Segunda fila de signos vitales -->
                            <div class="row g-2 mt-1">

                                <!-- Frecuencia Card√≠aca -->
                                <div class="col-12 col-lg-4">
                                    <div class="border rounded p-2 bg-white">
                                        <label class="form-label small fw-bold mb-1">
                                            <i class="bi bi-heart text-danger"></i> Freq. Card√≠aca
                                            <span id="puntaje-frecuencia_cardiaca-display-dash" class="badge bg-secondary ms-1">-</span>
                                        </label>
                                        <div class="btn-group-vertical d-grid gap-1" data-signo="frecuencia_cardiaca">
                                            <div class="row g-1">
                                                <div class="col-4">
                                                    <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="40" data-puntaje="3">
                                                        ‚â§40 <small>(3)</small>
                                                    </button>
                                                </div>
                                                <div class="col-4">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="45" data-puntaje="1">
                                                        41-50 <small>(1)</small>
                                                    </button>
                                                </div>
                                                <div class="col-4">
                                                    <button type="button" class="btn btn-outline-success btn-valor btn-sm w-100" data-valor="70" data-puntaje="0">
                                                        51-90 <small>(0)</small>
                                                    </button>
                                                </div>
                                                <div class="col-4">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="100" data-puntaje="1">
                                                        91-110 <small>(1)</small>
                                                    </button>
                                                </div>
                                                <div class="col-4">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="120" data-puntaje="2">
                                                        111-130 <small>(2)</small>
                                                    </button>
                                                </div>
                                                <div class="col-4">
                                                    <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="131" data-puntaje="3">
                                                        ‚â•131 <small>(3)</small>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Nivel de Conciencia -->
                                <div class="col-12 col-lg-4">
                                    <div class="border rounded p-2 bg-white">
                                        <label class="form-label small fw-bold mb-1">
                                            <i class="bi bi-eye text-warning"></i> Conciencia (AVPU)
                                            <span id="puntaje-nivel_conciencia-display-dash" class="badge bg-secondary ms-1">-</span>
                                        </label>
                                        <div class="btn-group-vertical d-grid gap-1" data-signo="nivel_conciencia">
                                            <div class="row g-1">
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-success btn-valor btn-sm w-100" data-valor="A" data-puntaje="0">
                                                        Alerta <small>(0)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="V" data-puntaje="3">
                                                        Voz <small>(3)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="P" data-puntaje="3">
                                                        Dolor <small>(3)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="U" data-puntaje="3">
                                                        Inconsci. <small>(3)</small>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Temperatura -->
                                <div class="col-12 col-lg-4">
                                    <div class="border rounded p-2 bg-white">
                                        <label class="form-label small fw-bold mb-1">
                                            <i class="bi bi-thermometer text-info"></i> Temperatura
                                            <span id="puntaje-temperatura-display-dash" class="badge bg-secondary ms-1">-</span>
                                        </label>
                                        <div class="btn-group-vertical d-grid gap-1" data-signo="temperatura">
                                            <div class="row g-1">
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="35.0" data-puntaje="3">
                                                        ‚â§35¬∞ <small>(3)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="35.5" data-puntaje="1">
                                                        35.1-36¬∞ <small>(1)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-success btn-valor btn-sm w-100" data-valor="37.0" data-puntaje="0">
                                                        36.1-38¬∞ <small>(0)</small>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-warning btn-valor btn-sm w-100" data-valor="38.5" data-puntaje="2">
                                                        38.1-39¬∞ <small>(2)</small>
                                                    </button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-danger btn-valor btn-sm w-100" data-valor="39.1" data-puntaje="3">
                                                ‚â•39.1¬∞ <small>(3)</small>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Campos ocultos para el formulario -->
                            <input type="hidden" id="frecuencia_respiratoria_dash" name="frecuencia_respiratoria" value="0" required>
                            <input type="hidden" id="saturacion_oxigeno_dash" name="saturacion_oxigeno" value="0" required>
                            <input type="hidden" id="tension_sistolica_dash" name="tension_sistolica" value="0" required>
                            <input type="hidden" id="frecuencia_cardiaca_dash" name="frecuencia_cardiaca" value="0" required>
                            <input type="hidden" id="nivel_conciencia_dash" name="nivel_conciencia" value="0" required>
                            <input type="hidden" id="temperatura_dash" name="temperatura" value="0" required>

                        </div>
                    </div>

                    <!-- BOT√ìN DE COMPLETAR -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-success btn-lg" id="btnCompletarDash">
                            <i class="bi bi-check-circle"></i> Completar Triage
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh cr√≠tico cada 2 minutos para emergencias
setInterval(() => {
    window.location.reload();
}, 120000);

// üßÆ CALCULADORA NEWS INTEGRADA EN DASHBOARD
console.log('üßÆ Inicializando calculadora NEWS en Dashboard...');

const calculadoraNEWSDashboard = {
    puntajes: {
        frecuencia_respiratoria: null,
        saturacion_oxigeno: null,
        tension_sistolica: null,
        frecuencia_cardiaca: null,
        nivel_conciencia: null,
        temperatura: null
    },
    valores: {
        frecuencia_respiratoria: null,
        saturacion_oxigeno: null,
        tension_sistolica: null,
        frecuencia_cardiaca: null,
        nivel_conciencia: null,
        temperatura: null
    },

    init: function() {
        const botones = document.querySelectorAll('.btn-valor');
        console.log(`Encontrados ${botones.length} botones en dashboard`);
        
        botones.forEach(boton => {
            boton.addEventListener('click', (e) => {
                e.preventDefault();
                this.seleccionarValor(e.target);
            });
        });
    },

    seleccionarValor: function(boton) {
        const seccionSigno = boton.closest('[data-signo]');
        if (!seccionSigno) {
            console.error('No se encontr√≥ secci√≥n de signo');
            return;
        }
        
        const signo = seccionSigno.dataset.signo;
        const valor = boton.dataset.valor;
        const puntaje = parseInt(boton.dataset.puntaje);
        
        console.log(`Dashboard - Seleccionando: ${signo} = ${valor} (${puntaje} puntos)`);
        
        // Quitar selecci√≥n previa
        seccionSigno.querySelectorAll('.btn-valor').forEach(btn => {
            btn.classList.remove('seleccionado');
        });
        
        // Marcar como seleccionado
        boton.classList.add('seleccionado');
        
        // Actualizar valores
        this.puntajes[signo] = puntaje;
        this.valores[signo] = valor;
        
        // Actualizar campo oculto con sufijo _dash
        const hiddenField = document.getElementById(signo + '_dash');
        if (hiddenField) {
            hiddenField.value = valor;
            console.log(`Campo oculto ${signo}_dash = ${valor}`);
        }
        
        // Actualizar display individual
        const displayElement = document.getElementById(`puntaje-${signo}-display-dash`);
        if (displayElement) {
            displayElement.textContent = puntaje;
            displayElement.className = `badge ms-1 ${puntaje === 0 ? 'bg-success' : puntaje === 1 || puntaje === 2 ? 'bg-warning' : 'bg-danger'}`;
        }
        
        // Recalcular total
        this.actualizarResultado();
    },
    
    actualizarResultado: function() {
        const puntajesArray = Object.values(this.puntajes);
        const totalSeleccionados = puntajesArray.filter(p => p !== null).length;
        
        console.log(`Dashboard - Puntajes seleccionados: ${totalSeleccionados}/6`);
        
        // Si no hay valores, mostrar estado inicial
        if (totalSeleccionados === 0) {
            this.mostrarEstadoInicial();
            return;
        }
        
        // Calcular puntaje total
        const puntajeTotal = puntajesArray.reduce((sum, p) => sum + (p || 0), 0);
        console.log(`Dashboard - Puntaje total: ${puntajeTotal}`);
        
        // Determinar clasificaci√≥n
        let clasificacion, colorClass, tiempoMax;
        
        if (puntajeTotal >= 7) {
            clasificacion = 'ROJO';
            colorClass = 'bg-danger';
            tiempoMax = 'INMEDIATO';
        } else if (puntajeTotal >= 5) {
            clasificacion = 'AMARILLO';
            colorClass = 'bg-warning text-dark';
            tiempoMax = '30 minutos';
        } else {
            clasificacion = 'VERDE';
            colorClass = 'bg-success';
            tiempoMax = '60 minutos';
        }
        
        console.log(`Dashboard - Clasificaci√≥n: ${clasificacion} (${tiempoMax})`);
        
        // Actualizar UI
        const colorDiv = document.getElementById('colorResultadoMiniDash');
        const puntajeDiv = document.getElementById('puntajeTotalMiniDash');
        const textoColor = document.getElementById('textoColorMiniDash');
        const tiempoDiv = document.getElementById('tiempoAtencionMiniDash');
        const textoTiempo = document.getElementById('textoTiempoMiniDash');
        
        if (colorDiv && puntajeDiv && textoColor) {
            colorDiv.className = `color-resultado-mini text-white rounded p-2 small ${colorClass}`;
            textoColor.textContent = clasificacion;
            
            puntajeDiv.textContent = puntajeTotal;
            puntajeDiv.className = `h4 ${puntajeTotal >= 7 ? 'text-danger' : puntajeTotal >= 5 ? 'text-warning' : 'text-success'}`;
            
            if (tiempoDiv && textoTiempo) {
                tiempoDiv.classList.remove('d-none');
                textoTiempo.textContent = tiempoMax;
                textoTiempo.className = `fw-bold small ${puntajeTotal >= 7 ? 'text-danger' : puntajeTotal >= 5 ? 'text-warning' : 'text-success'}`;
            }
        }
        
        // Mostrar resultado r√°pido
        const resultadoRapido = document.getElementById('resultado-rapido');
        const puntajeRapido = document.getElementById('puntaje-rapido');
        const colorRapido = document.getElementById('color-rapido');
        
        if (resultadoRapido && puntajeRapido && colorRapido) {
            resultadoRapido.classList.remove('d-none');
            puntajeRapido.textContent = puntajeTotal;
            puntajeRapido.className = `badge ${puntajeTotal >= 7 ? 'bg-danger' : puntajeTotal >= 5 ? 'bg-warning text-dark' : 'bg-success'}`;
            colorRapido.textContent = clasificacion;
            colorRapido.className = `badge ms-1 ${puntajeTotal >= 7 ? 'bg-danger' : puntajeTotal >= 5 ? 'bg-warning text-dark' : 'bg-success'}`;
        }
    },
    
    mostrarEstadoInicial: function() {
        const colorDiv = document.getElementById('colorResultadoMiniDash');
        const puntajeDiv = document.getElementById('puntajeTotalMiniDash');
        const textoColor = document.getElementById('textoColorMiniDash');
        const tiempoDiv = document.getElementById('tiempoAtencionMiniDash');
        const resultadoRapido = document.getElementById('resultado-rapido');
        
        if (colorDiv && puntajeDiv && textoColor) {
            colorDiv.className = 'color-resultado-mini bg-secondary text-white rounded p-2 small';
            textoColor.textContent = 'Selecciona valores';
            puntajeDiv.textContent = '--';
            puntajeDiv.className = 'h4 text-muted';
        }
        
        if (tiempoDiv) {
            tiempoDiv.classList.add('d-none');
        }
        
        if (resultadoRapido) {
            resultadoRapido.classList.add('d-none');
        }
        
        // Limpiar puntajes individuales
        Object.keys(this.puntajes).forEach(signo => {
            const displayElement = document.getElementById(`puntaje-${signo}-display-dash`);
            if (displayElement) {
                displayElement.textContent = '-';
                displayElement.className = 'badge bg-secondary ms-1';
            }
        });
    }
};

// üõ°Ô∏è VALIDACI√ìN DEL FORMULARIO DASHBOARD
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sistema Triage Dashboard iniciando...');
    
    // Inicializar calculadora
    calculadoraNEWSDashboard.init();
    
    // Validaci√≥n del formulario
    const form = document.getElementById('triageCompletoFormDashboard');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üîç Validando formulario dashboard antes del env√≠o...');
            
            // Verificar valores de NEWS
            const newsFields = ['frecuencia_respiratoria', 'saturacion_oxigeno', 'tension_sistolica', 
                              'frecuencia_cardiaca', 'nivel_conciencia', 'temperatura'];
            
            let allNewsComplete = true;
            let incompleteFields = [];
            
            newsFields.forEach(field => {
                const hiddenField = document.getElementById(field + '_dash');
                if (!hiddenField || !hiddenField.value || hiddenField.value === '0') {
                    allNewsComplete = false;
                    incompleteFields.push(field);
                }
                console.log(`üìä ${field}: ${hiddenField ? hiddenField.value : 'NO ENCONTRADO'}`);
            });
            
            if (!allNewsComplete) {
                e.preventDefault();
                alert(`‚ö†Ô∏è Por favor complete todos los signos vitales de NEWS:\n\n${incompleteFields.map(f => f.replace('_', ' ')).join('\n')}\n\nSeleccione los botones correspondientes en la calculadora.`);
                console.warn('‚ùå Formulario dashboard bloqueado: Faltan valores NEWS', incompleteFields);
                return false;
            }
            
            console.log('‚úÖ Validaci√≥n dashboard completa - enviando formulario');
            return true;
        });
    }
});

// CSS para selecci√≥n de botones
const styleSheet = document.createElement('style');
styleSheet.textContent = `
    .btn-valor.seleccionado {
        background-color: var(--bs-primary) !important;
        color: white !important;
        border-color: var(--bs-primary) !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
        transform: scale(1.05);
        transition: all 0.2s ease;
    }
    
    .btn-valor:hover {
        transform: scale(1.02);
        transition: all 0.2s ease;
    }
    
    .color-resultado-mini {
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
`;
document.head.appendChild(styleSheet);

</script>
{% endblock %}